syntax = "proto3";

package spiredb;

// PD Service
service PlacementDriver {
  // Store registration
  rpc RegisterStore(RegisterStoreRequest) returns (RegisterStoreResponse);
  rpc StoreHeartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  
  // Region routing
  rpc GetRegion(GetRegionRequest) returns (GetRegionResponse);
  rpc GetRegionByKey(GetRegionByKeyRequest) returns (GetRegionByKeyResponse);
  
  // Schema management
  rpc CreateTable(CreateTableRequest) returns (CreateTableResponse);
  rpc GetTable(GetTableRequest) returns (GetTableResponse);
  rpc ListTables(ListTablesRequest) returns (ListTablesResponse);
  
  // Admin
  rpc GetClusterInfo(GetClusterInfoRequest) returns (GetClusterInfoResponse);
}

// Store Service (Internal)
service Store {
  // KV operations (Internal use or replication)
  rpc Get(GetRequest) returns (GetResponse);
  rpc Put(PutRequest) returns (PutResponse);
  rpc Delete(DeleteRequest) returns (DeleteResponse);
  rpc BatchPut(BatchPutRequest) returns (BatchPutResponse);
  
  // Admin
  rpc GetRegionInfo(GetRegionInfoRequest) returns (GetRegionInfoResponse);
  rpc SplitRegion(SplitRegionRequest) returns (SplitRegionResponse);
}

// Coprocessor Service (SpireSQL Interface)
service Coprocessor {
  // Push down filter/scan operations
  rpc Execute(CoprocessorRequest) returns (stream CoprocessorResponse);
}

// Messages

message RegisterStoreRequest {
  string address = 1;
  uint64 capacity = 2;
  map<string, string> labels = 3;
}

message RegisterStoreResponse {
  uint64 store_id = 1;
}

message HeartbeatRequest {
  uint64 store_id = 1;
  StoreStats stats = 2;
}

message StoreStats {
  uint64 available_space = 1;
  uint32 region_count = 2;
  repeated RegionStats regions = 3;
}

message RegionStats {
  uint64 region_id = 1;
  uint64 approximate_size = 2;
  uint64 approximate_keys = 3;
  uint64 qps = 4;
}

message HeartbeatResponse {}

message GetRegionRequest {
  uint64 region_id = 1;
}

message GetRegionResponse {
  Region region = 1;
}

message GetRegionByKeyRequest {
  bytes key = 1;
}

message GetRegionByKeyResponse {
  Region region = 1;
}

message Region {
  uint64 id = 1;
  bytes start_key = 2;
  bytes end_key = 3;
  repeated Replica replicas = 4;
  uint64 epoch = 5;
  uint64 leader_store_id = 6;
}

message Replica {
  uint64 store_id = 1;
  ReplicaRole role = 2;
}

enum ReplicaRole {
  FOLLOWER = 0;
  LEADER = 1;
}

// Schema Messages
message CreateTableRequest {
  string name = 1;
  // Simplified schema definition for now
  bytes schema_json = 2; 
}

message CreateTableResponse {
  uint64 table_id = 1;
}

message GetTableRequest {
  oneof identifier {
    uint64 id = 1;
    string name = 2;
  }
}

message GetTableResponse {
  uint64 id = 1;
  string name = 2;
  bytes schema_json = 3;
}

message ListTablesRequest {}
message ListTablesResponse {
  repeated GetTableResponse tables = 1;
}

message GetClusterInfoRequest {}
message GetClusterInfoResponse {
  repeated StoreInfo stores = 1;
}

message StoreInfo {
  uint64 id = 1;
  string address = 2;
  string state = 3;
}

// KV messages

message GetRequest {
  bytes key = 1;
}

message GetResponse {
  bytes value = 1;
  bool found = 2;
}

message PutRequest {
  bytes key = 1;
  bytes value = 2;
}

message PutResponse {}

message DeleteRequest {
  bytes key = 1;
}

message DeleteResponse {
  bool deleted = 1;
}

message BatchPutRequest {
  repeated KVPair pairs = 1;
}

message BatchPutResponse {}

message KVPair {
  bytes key = 1;
  bytes value = 2;
}

message GetRegionInfoRequest {
    uint64 region_id = 1;
}

message GetRegionInfoResponse {
    Region region = 1;
    RegionStats stats = 2;
}

message SplitRegionRequest {
    uint64 region_id = 1;
    bytes split_key = 2;
}

message SplitRegionResponse {
    uint64 new_region_id = 1;
    repeated uint64 new_peer_ids = 2;
}

// Coprocessor Messages

message CoprocessorRequest {
  uint64 region_id = 1;
  // Serialized physical plan or filter expression
  bytes plan = 2;
  repeated KeyRange ranges = 3;
}

message KeyRange {
  bytes start = 1;
  bytes end = 2;
}

message CoprocessorResponse {
  // Serialized result batch (e.g. Apache Arrow IPC or custom format)
  bytes data = 1;
  string error = 2;
}
